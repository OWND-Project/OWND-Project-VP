<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Received Credential Information</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h3 class="mb-0">Received Credential Information</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">The following credential information was successfully received from the wallet.</p>

                        <!-- ID Token Section -->
                        <h5 class="mt-4 mb-3">ID Token</h5>
                        <div class="card mb-4">
                            <div class="card-body">
                                <pre class="mb-0" style="white-space: pre-wrap; word-break: break-all;"><%= idToken %></pre>
                            </div>
                        </div>

                        <!-- Learning Credential Section -->
                        <% if (learningCredential) { %>
                        <h5 class="mt-4 mb-3">Learning Credential</h5>

                        <% if (learningCredential.fields) { %>
                            <!-- Decoded Fields -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <table class="table table-bordered mb-0">
                                        <tbody>
                                            <% if (learningCredential.fields.issuing_authority) { %>
                                            <tr>
                                                <th style="width: 30%">発行機関</th>
                                                <td><%= learningCredential.fields.issuing_authority %></td>
                                            </tr>
                                            <% } %>
                                            <% if (learningCredential.fields.issuing_country) { %>
                                            <tr>
                                                <th>発行国</th>
                                                <td><%= learningCredential.fields.issuing_country %></td>
                                            </tr>
                                            <% } %>
                                            <% if (learningCredential.fields.date_of_issuance) { %>
                                            <tr>
                                                <th>発行日</th>
                                                <td><%= learningCredential.fields.date_of_issuance %></td>
                                            </tr>
                                            <% } %>
                                            <% if (learningCredential.fields.family_name) { %>
                                            <tr>
                                                <th>姓</th>
                                                <td><%= learningCredential.fields.family_name %></td>
                                            </tr>
                                            <% } %>
                                            <% if (learningCredential.fields.given_name) { %>
                                            <tr>
                                                <th>名</th>
                                                <td><%= learningCredential.fields.given_name %></td>
                                            </tr>
                                            <% } %>
                                            <% if (learningCredential.fields.achievement_title) { %>
                                            <tr>
                                                <th>成果タイトル</th>
                                                <td><%= learningCredential.fields.achievement_title %></td>
                                            </tr>
                                            <% } %>
                                            <% if (learningCredential.fields.achievement_description) { %>
                                            <tr>
                                                <th>成果説明</th>
                                                <td><%= learningCredential.fields.achievement_description %></td>
                                            </tr>
                                            <% } %>
                                            <% if (learningCredential.fields.learning_outcomes) { %>
                                            <tr>
                                                <th>学習成果</th>
                                                <td><%= learningCredential.fields.learning_outcomes %></td>
                                            </tr>
                                            <% } %>
                                            <% if (learningCredential.fields.assessment_grade) { %>
                                            <tr>
                                                <th>評価・成績</th>
                                                <td><%= learningCredential.fields.assessment_grade %></td>
                                            </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Raw JWT (collapsible) -->
                            <div class="accordion mb-4" id="rawJwtAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rawJwtCollapse">
                                            生のSD-JWT（技術者向け）
                                        </button>
                                    </h2>
                                    <div id="rawJwtCollapse" class="accordion-collapse collapse" data-bs-parent="#rawJwtAccordion">
                                        <div class="accordion-body">
                                            <pre class="mb-0" style="white-space: pre-wrap; word-break: break-all;"><%= learningCredential.rawJwt %></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% } else if (learningCredential.error) { %>
                            <!-- Error decoding -->
                            <div class="alert alert-warning mb-4">
                                <strong>デコードエラー:</strong> <%= learningCredential.error %>
                            </div>
                            <div class="card mb-4">
                                <div class="card-body">
                                    <pre class="mb-0" style="white-space: pre-wrap; word-break: break-all;"><%= learningCredential.rawJwt %></pre>
                                </div>
                            </div>
                        <% } %>
                        <% } %>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <a href="/" class="btn btn-primary">New Request</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mark this session as committed to stop any ongoing polling
        // This prevents error screens from appearing after the credential has been successfully received
        const urlParams = new URLSearchParams(window.location.search);
        const requestId = urlParams.get('request_id');
        if (requestId) {
            sessionStorage.setItem(`committed_${requestId}`, 'true');
        }
    </script>
</body>
</html>
